---
date: 2025-03-25 14:54:50
tags:
  - JavaScript
  - 面试
  - 前端
  - 手搓代码
---

# 大文件上传

## 文件上传基础

首先，我们需要熟悉一下基本的文件上传流程：

<<< ./snippets/file-base.html

我们可以通过 `slice` 方法将文件按字节分割，得到 `Blob` 对象，并将其输出观察：

![alt](https://blog-1328542955.cos.ap-shanghai.myqcloud.com/PixPin_2025-03-25_15-04-23.png)

## 分片上传

既然如此，我们就可以封装切片函数来达到分片上传的目的：

<<< ./snippets/slice.js

效果如下：

![alt](https://blog-1328542955.cos.ap-shanghai.myqcloud.com/PixPin_2025-03-25_15-07-45.png)

:::info
文件分片很快，无论你文件多大都会瞬间成功。这是因为，分片仅仅只是一次数学运算，File 和 Blob 都不涉及文件数据。
:::

## 断点续传

断点续传，顾名思义，就是上传过程中断开，下次再传的时候，从上次中断的地方继续上传。

这一步的实现需要发起请求，客户端告诉服务器“这个文件上传到哪里了”，服务器返回“我还需要 a 到 b 范围内字节的数据”。

这就出现问题了——怎么表示“这个文件”？文件名是可能重复的啊！发绝对路径给服务器吗？那如果路径变化了呢？我的文件发生过移动呢？

解决方案就是，你要找到每个文件的唯一标识，所以我们可以采用 `md5` 来生成文件唯一标识。

接下来的任务就是编写文件标识函数，当然，我们需要采用增量算法，不要忘记正在处理大文件上传的背景：

<<< ./snippets/file-hash.html

效果如下：

![alt](https://blog-1328542955.cos.ap-shanghai.myqcloud.com/PixPin_2025-03-25_15-25-57.png)

我们接下来把它封装成异步函数，因为这样的操作是消耗时间的：

<<< ./snippets/file-async.js

写到这一步，附上一版临时代码以供参考：

<<< ./snippets/file-0325-122929.html
